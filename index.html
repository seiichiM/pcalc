<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Poker Equity Calc</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --picker-height: 40vh; /* Consistent height */
        }

        body {
            background-color: #1a202c;
            color: #e2e8f0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            touch-action: manipulation;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* --- Card Styles --- */
        .card-slot {
            aspect-ratio: 2.5 / 3.5;
            background-color: #2d3748;
            border: 2px dashed #4a5568;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: clamp(0.7rem, 1.5vh, 1rem);
            cursor: pointer;
            transition: all 0.1s;
            position: relative;
            line-height: 1;
            min-width: 0; /* Important for flex shrinking */
        }
        .card-slot.active {
            border-color: #f6ad55;
            box-shadow: 0 0 0 2px rgba(246, 173, 85, 0.5);
            background-color: #2d3748;
        }
        .card-slot.filled {
            border-style: solid;
            border-color: #cbd5e0;
            background-color: white;
            color: black;
        }
        
        /* 4-Color Deck */
        .suit-s { color: #1a202c; } 
        .suit-h { color: #e53e3e; } 
        .suit-d { color: #3182ce; } 
        .suit-c { color: #38a169; } 

        /* --- Layout Areas --- */
        .header-area { flex: 0 0 auto; }
        .table-area {
            flex: 1 1 auto;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 0.5rem;
            background: rgba(20, 83, 45, 0.2);
            overflow-y: auto;
            min-height: 0;
        }
        .picker-area {
            flex: 0 0 auto;
            background-color: #2d3748;
            border-top: 1px solid #4a5568;
            padding: 8px;
            height: var(--picker-height);
            display: flex;
            flex-direction: column;
        }

        /* --- Picker Grids --- */
        .suit-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 8px;
            height: 100%;
            width: 100%;
        }
        .suit-btn {
            background: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .suit-btn:active { transform: scale(0.98); }

        .rank-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            height: 100%;
            width: 100%;
            align-content: stretch;
        }
        .rank-btn {
            background: white;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: #1a202c;
            cursor: pointer;
            flex-grow: 1; 
            margin-bottom: 0;
            box-sizing: border-box;
        }
        .rank-btn.width-third {
            width: calc(33.333% - 4px); 
            height: calc(25% - 4px); 
        }
        .rank-btn.width-quarter {
            width: calc(25% - 4px);
            height: calc(25% - 4px);
        }
        .rank-btn.disabled {
            opacity: 0.2;
            pointer-events: none;
            background: #718096;
        }
        .rank-btn:active { background: #e2e8f0; }
        
        .rank-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
            height: 30px;
        }

    </style>

    <!-- PWA Settings -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon-192.png">
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js');
        }
    </script>
</head>
<body>

    <!-- Header -->
    <div class="header-area bg-gray-800 p-2 border-b border-gray-700 flex justify-between items-center shadow-md z-10">
        <div class="flex flex-col">
            <div class="text-[10px] text-gray-400 uppercase tracking-wider">Win Equity</div>
            <div class="text-2xl font-bold text-gray-500" id="win-rate">--%</div>
        </div>
        <div class="text-right">
            <div class="text-[10px] text-gray-400 uppercase tracking-wider">Tie</div>
            <div class="text-lg font-bold text-gray-400" id="tie-rate">--%</div>
        </div>
        <div class="flex items-center gap-2">
             <div class="flex items-center gap-1 bg-gray-700 rounded p-1 mr-2">
                <button onclick="changeOpponents(-1)" class="w-8 h-8 flex items-center justify-center bg-gray-600 rounded hover:bg-gray-500 font-bold text-lg">-</button>
                <div class="flex flex-col items-center px-1">
                    <span id="opp-count" class="font-mono text-lg font-bold leading-none">1</span>
                    <span class="text-[9px] text-gray-400 leading-none">OPP</span>
                </div>
                <button onclick="changeOpponents(1)" class="w-8 h-8 flex items-center justify-center bg-gray-600 rounded hover:bg-gray-500 font-bold text-lg">+</button>
            </div>
            <button onclick="resetAll()" class="bg-red-900 hover:bg-red-800 text-red-200 text-xs py-2 px-3 rounded font-bold">
                RESET
            </button>
        </div>
    </div>

    <!-- Table: Wide Gap Layout -->
    <div class="table-area">
        <div class="w-full max-w-4xl mx-auto flex flex-col gap-1 items-center">
            
            <!-- Cards Row (Large Gap) -->
            <div class="flex gap-16 h-20 md:h-28 w-full px-4 justify-center">
                <!-- Hole Cards (2) -->
                <div class="flex gap-2 flex-1 max-w-[120px]">
                    <div class="card-slot flex-1" id="hole-1" onclick="selectSlot('hole-1')"></div>
                    <div class="card-slot flex-1" id="hole-2" onclick="selectSlot('hole-2')"></div>
                </div>

                <!-- Board Cards (5) -->
                <div class="flex gap-2 flex-[2.5] max-w-[300px]">
                    <div class="card-slot flex-1" id="board-1" onclick="selectSlot('board-1')"></div>
                    <div class="card-slot flex-1" id="board-2" onclick="selectSlot('board-2')"></div>
                    <div class="card-slot flex-1" id="board-3" onclick="selectSlot('board-3')"></div>
                    <div class="card-slot flex-1" id="board-4" onclick="selectSlot('board-4')"></div>
                    <div class="card-slot flex-1" id="board-5" onclick="selectSlot('board-5')"></div>
                </div>
            </div>
            
            <!-- Labels (Underneath for clarity or just rely on grouping) -->
             <div class="flex gap-16 w-full px-4 justify-center text-[10px] text-gray-400 font-bold mt-1">
                 <div class="flex-1 max-w-[120px] text-center">HAND</div>
                 <div class="flex-[2.5] max-w-[300px] text-center">BOARD</div>
             </div>

            <!-- Loading Indicator -->
            <div class="h-6 flex justify-center items-center mt-2">
                 <div id="loading" class="hidden text-yellow-400 text-sm animate-pulse font-mono">Simulating...</div>
            </div>

        </div>
    </div>

    <!-- Picker -->
    <div class="picker-area">
        <div id="picker-container" class="h-full w-full">
            <!-- Injected by JS -->
        </div>
    </div>

    <script>
        // --- Game Logic ---
        const SUITS = ['s', 'h', 'd', 'c']; 
        const RANKS = ['2','3','4','5','6','7','8','9','T','J','Q','K','A'];
        const SYMBOLS = {'s':'♠', 'h':'♥', 'd':'♦', 'c':'♣'};
        
        let state = {
            opponents: 1,
            hole: [null, null],
            board: [null, null, null, null, null],
            currentSlot: 'hole-1',
            tempSuit: null // null = picking suit, 0-3 = picking rank
        };

        // --- Evaluator (Compact) ---
        const R_STRAIGHT_FLUSH = 8000000;
        const R_QUADS          = 7000000;
        const R_FULL_HOUSE     = 6000000;
        const R_FLUSH          = 5000000;
        const R_STRAIGHT       = 4000000;
        const R_TRIPS          = 3000000;
        const R_TWO_PAIR       = 2000000;
        const R_PAIR           = 1000000;
        const R_HIGH_CARD      = 0;

        function evaluate7Cards(cards) {
            if (!cards || cards.length < 5) return 0;
            cards.sort((a,b) => b.r - a.r);
            let flushSuit = -1;
            const suitCounts = [0,0,0,0];
            for(let c of cards) suitCounts[c.s]++;
            for(let i=0; i<4; i++) if(suitCounts[i] >= 5) flushSuit = i;
            const flushCards = (flushSuit !== -1) ? cards.filter(c => c.s === flushSuit) : [];

            function getStraightHigh(cardList) {
                let ranks = [...new Set(cardList.map(c => c.r))];
                if (ranks.length < 5) return -1;
                let isAceLow = false;
                if(ranks.includes(12) && ranks.includes(0) && ranks.includes(1) && ranks.includes(2) && ranks.includes(3)) isAceLow = true;
                for (let i = 0; i <= ranks.length - 5; i++) {
                    if (ranks[i] - ranks[i+4] === 4) return ranks[i];
                }
                if(isAceLow) return 3; 
                return -1;
            }

            if (flushSuit !== -1) {
                const sfHigh = getStraightHigh(flushCards);
                if (sfHigh !== -1) return R_STRAIGHT_FLUSH + sfHigh;
            }
            const rankCounts = new Array(13).fill(0);
            for(let c of cards) rankCounts[c.r]++;
            let quads = -1, trips = [], pairs = [];
            for(let r=12; r>=0; r--) {
                if(rankCounts[r] === 4) quads = r;
                else if(rankCounts[r] === 3) trips.push(r);
                else if(rankCounts[r] === 2) pairs.push(r);
            }
            if (quads !== -1) {
                let kicker = -1;
                for(let c of cards) if(c.r !== quads) { kicker = c.r; break; }
                return R_QUADS + (quads * 100) + kicker;
            }
            if (trips.length > 0) {
                const bestTrip = trips[0];
                let bestPair = -1;
                if (trips.length > 1) bestPair = trips[1]; 
                else if (pairs.length > 0) bestPair = pairs[0];
                if (bestPair !== -1) return R_FULL_HOUSE + (bestTrip * 100) + bestPair;
            }
            if (flushSuit !== -1) {
                let score = 0;
                for(let i=0; i<5; i++) score += flushCards[i].r * Math.pow(13, 4-i);
                return R_FLUSH + score;
            }
            const straightHigh = getStraightHigh(cards);
            if (straightHigh !== -1) return R_STRAIGHT + straightHigh;
            if (trips.length > 0) {
                const t = trips[0];
                let k1 = -1, k2 = -1;
                for(let c of cards) { if(c.r !== t) { if(k1 === -1) k1 = c.r; else if(k2 === -1) { k2 = c.r; break; } } }
                return R_TRIPS + (t * 200) + (k1 * 14) + k2;
            }
            if (pairs.length >= 2) {
                const p1 = pairs[0], p2 = pairs[1];
                let k = -1;
                for(let c of cards) if(c.r !== p1 && c.r !== p2) { k = c.r; break; }
                return R_TWO_PAIR + (p1 * 200) + (p2 * 14) + k;
            }
            if (pairs.length > 0) {
                const p = pairs[0];
                let kickers = [];
                for(let c of cards) if(c.r !== p) kickers.push(c.r);
                let kScore = kickers[0]*200 + kickers[1]*14 + kickers[2];
                return R_PAIR + (p * 4000) + kScore;
            }
            let score = 0;
            for(let i=0; i<5; i++) score += cards[i].r * Math.pow(13, 4-i);
            return R_HIGH_CARD + score;
        }

        function runSimulation() {
            const myCards = state.hole.filter(c => c !== null);
            if (myCards.length < 2) return null;
            const boardCards = state.board.filter(c => c !== null);
            
            let deck = [];
            const known = new Set([...myCards, ...boardCards].map(c => `${c.r},${c.s}`));
            for(let r=0; r<13; r++) {
                for(let s=0; s<4; s++) {
                    if(!known.has(`${r},${s}`)) deck.push({r, s});
                }
            }

            let wins = 0; let ties = 0; const ITERATIONS = 3000;
            for(let i=0; i<ITERATIONS; i++) {
                const needed = (5 - boardCards.length) + (state.opponents * 2);
                if (deck.length < needed) break;
                let tempDeck = [...deck];
                let drawn = [];
                for(let k=0; k<needed; k++) {
                    const idx = Math.floor(Math.random() * tempDeck.length);
                    drawn.push(tempDeck[idx]);
                    tempDeck[idx] = tempDeck[tempDeck.length-1];
                    tempDeck.pop();
                }
                let dealIdx = 0;
                let simBoard = [...boardCards];
                while(simBoard.length < 5) simBoard.push(drawn[dealIdx++]);
                const myScore = evaluate7Cards([...myCards, ...simBoard]);
                let lost = false; let tied = false;
                for(let o=0; o<state.opponents; o++) {
                    const oppHand = [drawn[dealIdx++], drawn[dealIdx++]];
                    const oppScore = evaluate7Cards([...oppHand, ...simBoard]);
                    if (oppScore > myScore) { lost = true; break; }
                    else if (oppScore === myScore) tied = true;
                }
                if (!lost) { if (tied) ties++; else wins++; }
            }
            return { wins, ties, total: ITERATIONS };
        }

        // --- UI ---

        function renderPicker() {
            const container = document.getElementById('picker-container');
            container.innerHTML = '';

            if (state.tempSuit === null) {
                // Show Suit Picker
                const grid = document.createElement('div');
                grid.className = 'suit-grid';
                SUITS.forEach((suit, idx) => {
                    const btn = document.createElement('div');
                    btn.className = `suit-btn suit-${suit}`;
                    btn.innerHTML = SYMBOLS[suit];
                    btn.onclick = () => {
                        state.tempSuit = idx;
                        renderPicker();
                    };
                    grid.appendChild(btn);
                });
                container.appendChild(grid);
            } else {
                // Show Rank Picker
                const header = document.createElement('div');
                header.className = 'rank-header';
                
                const suitChar = SUITS[state.tempSuit];
                header.innerHTML = `
                    <div class="flex items-center gap-2 text-xl font-bold">
                        <span class="text-white">Select Rank for:</span>
                        <span class="suit-${suitChar} bg-white px-2 rounded">${SYMBOLS[suitChar]}</span>
                    </div>
                    <button onclick="cancelSuit()" class="bg-gray-600 text-xs px-2 py-1 rounded">CANCEL</button>
                `;
                container.appendChild(header);

                const usedRanks = new Set();
                [...state.hole, ...state.board].forEach(c => {
                    if(c && c.s === state.tempSuit) usedRanks.add(c.r);
                });

                const grid = document.createElement('div');
                grid.className = 'rank-grid';
                grid.style.height = 'calc(100% - 34px)';

                RANKS.forEach((rank, rIdx) => {
                    const btn = document.createElement('div');
                    const isUsed = usedRanks.has(rIdx);
                    // Add layout classes
                    const layoutClass = rIdx < 9 ? 'width-third' : 'width-quarter';

                    btn.className = `rank-btn suit-${suitChar} ${layoutClass} ${isUsed ? 'disabled' : ''}`;
                    btn.innerHTML = rank;
                    btn.onclick = () => pickRank(rIdx);
                    grid.appendChild(btn);
                });
                container.appendChild(grid);
            }
        }

        function cancelSuit() {
            state.tempSuit = null;
            renderPicker();
        }

        function pickRank(rIdx) {
            if (!state.currentSlot || state.tempSuit === null) return;
            
            const card = {r: rIdx, s: state.tempSuit};
            const type = state.currentSlot.split('-')[0];
            const idx = parseInt(state.currentSlot.split('-')[1]) - 1;

            if (type === 'hole') state.hole[idx] = card;
            else state.board[idx] = card;

            // Reset logic
            state.tempSuit = null;
            clearResults();
            advanceSlot();
            renderSlots();
            renderPicker();
            
            if (state.hole[0] && state.hole[1]) setTimeout(calculate, 20);
        }

        function renderSlots() {
            state.hole.forEach((c, i) => updateSlotUI(`hole-${i+1}`, c));
            state.board.forEach((c, i) => updateSlotUI(`board-${i+1}`, c));

            document.querySelectorAll('.card-slot').forEach(el => el.classList.remove('active'));
            if(state.currentSlot) {
                document.getElementById(state.currentSlot).classList.add('active');
            }
        }

        function updateSlotUI(id, card) {
            const el = document.getElementById(id);
            if (card) {
                const suitChar = SUITS[card.s];
                el.className = `card-slot filled suit-${suitChar}`;
                el.innerHTML = `<span style="font-size:0.9em">${RANKS[card.r]}</span><span style="font-size:0.9em">${SYMBOLS[suitChar]}</span>`;
            } else {
                el.className = 'card-slot';
                el.innerHTML = '';
            }
        }

        function selectSlot(id) {
            state.currentSlot = id;
            state.tempSuit = null; // Reset picker to suits
            
            const type = id.split('-')[0];
            const idx = parseInt(id.split('-')[1]) - 1;
            
            if (type === 'hole' && state.hole[idx]) {
                state.hole[idx] = null;
                clearResults();
            } else if (type === 'board' && state.board[idx]) {
                state.board[idx] = null;
                clearResults();
            }
            renderSlots();
            renderPicker();
        }

        function advanceSlot() {
            const order = ['hole-1', 'hole-2', 'board-1', 'board-2', 'board-3', 'board-4', 'board-5'];
            const currIdx = order.indexOf(state.currentSlot);
            if (currIdx !== -1 && currIdx < order.length - 1) state.currentSlot = order[currIdx + 1];
            else state.currentSlot = null;
        }

        function changeOpponents(delta) {
            let newCount = state.opponents + delta;
            if (newCount < 1) newCount = 1;
            if (newCount > 9) newCount = 9;
            state.opponents = newCount;
            document.getElementById('opp-count').innerText = newCount;
            clearResults();
            if (state.hole[0] && state.hole[1]) calculate();
        }

        function resetAll() {
            state.hole = [null, null];
            state.board = [null, null, null, null, null];
            state.currentSlot = 'hole-1';
            state.tempSuit = null;
            clearResults();
            renderSlots();
            renderPicker();
        }

        function clearResults() {
            document.getElementById('win-rate').innerText = '--%';
            document.getElementById('tie-rate').innerText = '--%';
            document.getElementById('win-rate').className = 'text-2xl font-bold text-gray-500';
        }

        function calculate() {
            if (!state.hole[0] || !state.hole[1]) return;
            document.getElementById('loading').classList.remove('hidden');
            setTimeout(() => {
                const res = runSimulation();
                document.getElementById('loading').classList.add('hidden');
                if (!res) return;
                const winPct = (res.wins / res.total * 100).toFixed(0);
                const tiePct = (res.ties / res.total * 100).toFixed(0);
                const winEl = document.getElementById('win-rate');
                winEl.innerText = winPct + '%';
                const fairShare = 100 / (state.opponents + 1);
                if (parseFloat(winPct) > fairShare * 1.1) winEl.className = 'text-2xl font-bold text-green-400';
                else if (parseFloat(winPct) < fairShare * 0.9) winEl.className = 'text-2xl font-bold text-red-400';
                else winEl.className = 'text-2xl font-bold text-yellow-400';
                document.getElementById('tie-rate').innerText = tiePct + '%';
            }, 10);
        }

        // Init
        renderSlots();
        renderPicker();

    </script>
</body>
</html>
